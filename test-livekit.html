<!DOCTYPE html>
<html>
<head>
    <title>LiveKit Connection Test</title>
    <script src="https://unpkg.com/livekit-client/dist/livekit-client.umd.min.js"></script>
</head>
<body>
    <h1>LiveKit Connection Test</h1>

    <div>
        <h2>Step 1: Create Session</h2>
        <button onclick="createSession()">Create Session</button>
        <pre id="session-info"></pre>
    </div>

    <div>
        <h2>Step 2: Connect to Room</h2>
        <button onclick="connectToRoom()">Connect</button>
        <div id="status"></div>
    </div>

    <div>
        <h2>Video Preview</h2>
        <div id="video-container"></div>
    </div>

    <script>
        let sessionId = null;
        let token = null;
        let serverUrl = null;
        let room = null;

        async function createSession() {
            try {
                const response = await fetch('http://localhost:8080/api/live/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: 'Test Session',
                        owner_name: 'Test User'
                    })
                });

                const data = await response.json();
                console.log('Session created:', data);

                sessionId = data.session_id;
                token = data.host_token;
                serverUrl = data.server_url;

                document.getElementById('session-info').textContent = JSON.stringify(data, null, 2);
                document.getElementById('status').textContent = 'Session created! Now click Connect.';
                document.getElementById('status').style.color = 'green';
            } catch (error) {
                console.error('Error creating session:', error);
                document.getElementById('status').textContent = 'Error: ' + error.message;
                document.getElementById('status').style.color = 'red';
            }
        }

        async function connectToRoom() {
            if (!token || !serverUrl) {
                alert('Please create a session first!');
                return;
            }

            try {
                document.getElementById('status').textContent = 'Connecting...';
                document.getElementById('status').style.color = 'orange';

                room = new LivekitClient.Room({
                    adaptiveStream: true,
                    dynacast: true,
                });

                room.on('connected', () => {
                    console.log('Connected to room!');
                    document.getElementById('status').textContent = 'Connected successfully!';
                    document.getElementById('status').style.color = 'green';
                });

                room.on('disconnected', (reason) => {
                    console.log('Disconnected:', reason);
                    document.getElementById('status').textContent = 'Disconnected: ' + reason;
                    document.getElementById('status').style.color = 'red';
                });

                room.on('participantConnected', (participant) => {
                    console.log('Participant connected:', participant.identity);
                });

                room.on('trackSubscribed', (track, publication, participant) => {
                    if (track.kind === 'video') {
                        const element = track.attach();
                        document.getElementById('video-container').appendChild(element);
                    }
                });

                await room.connect(serverUrl, token);

                // Enable camera and microphone
                await room.localParticipant.setCameraEnabled(true);
                await room.localParticipant.setMicrophoneEnabled(true);

                console.log('Local tracks published');

            } catch (error) {
                console.error('Error connecting:', error);
                document.getElementById('status').textContent = 'Connection error: ' + error.message;
                document.getElementById('status').style.color = 'red';
            }
        }
    </script>
</body>
</html>
